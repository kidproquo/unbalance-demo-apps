# MCP Server for CNN Unbalance Detection

This MCP (Model Context Protocol) server provides real-time monitoring and access to the CNN unbalance detection system's metrics and detection events.

## Features

The MCP server exposes three tools that can be queried by MCP clients (like Claude Desktop):

### 1. `get_performance_metrics`
Get the latest performance metrics from the CNN detection system.

**Returns:**
- Per-dataset metrics (TP, FP, TN, FN, Accuracy, Precision, Recall) for each dataset (0E-4E)
- Overall metrics across all datasets
- Report file name and last update timestamp

**Example response:**
```json
{
  "status": "success",
  "metrics": {
    "report_file": "performance_report_20251119_145230.txt",
    "last_updated": "2025-11-19T14:52:30",
    "datasets": {
      "0E": {
        "total": 49,
        "TP": 0,
        "FP": 14,
        "TN": 35,
        "FN": 0,
        "accuracy": 0.714,
        "precision": 0.0,
        "recall": 0.0
      },
      "1E": {
        "total": 1,
        "TP": 1,
        "FP": 0,
        "TN": 0,
        "FN": 0,
        "accuracy": 1.0,
        "precision": 1.0,
        "recall": 1.0
      }
    },
    "overall": {
      "total": 56,
      "TP": 7,
      "FP": 14,
      "TN": 35,
      "FN": 0,
      "accuracy": 0.75,
      "precision": 0.333,
      "recall": 1.0
    }
  }
}
```

### 2. `get_recent_detections`
Get the most recent unbalance detection events.

**Parameters:**
- `limit` (optional): Maximum number of detections to return (default: 10)

**Returns:**
- List of recent detection events with:
  - Timestamp (UTC)
  - Dataset source
  - Window index and row indices
  - Detection ratio and prediction scores
  - Associated figure filename

**Example response:**
```json
{
  "status": "success",
  "count": 3,
  "detections": [
    {
      "timestamp": "2025-11-19 14:45:12",
      "window_idx": 42,
      "dataset": "3E",
      "dataset_name": "Unbalance Level 3",
      "start_idx": 614400,
      "end_idx": 860160,
      "detection_ratio": 0.883,
      "mean_prediction": 0.8521,
      "max_prediction": 0.9234,
      "figure_file": "unbalance_detection_3E_20251119_144512_row614400.png"
    }
  ]
}
```

### 3. `get_system_status`
Get the overall status of the CNN detection system.

**Returns:**
- System status (active/inactive/stale)
- Whether processing is currently running
- Last update timestamp and age
- Overall accuracy
- Total windows processed
- Recent detection count

**Example response:**
```json
{
  "status": "active",
  "running": true,
  "last_update": "2025-11-19T14:52:30",
  "age_minutes": 2.5,
  "overall_accuracy": 0.75,
  "total_windows_processed": 56,
  "recent_detections_count": 3,
  "report_file": "performance_report_20251119_145230.txt"
}
```

## Installation

### Prerequisites
- Python 3.8-3.11 (same as the CNN approach)
- Virtual environment with dependencies installed

### Install FastMCP
```bash
# Activate your virtual environment
source ../../venv_py311/bin/activate

# Install fastmcp
pip install fastmcp
```

## Usage

### Running the MCP Server

**Option 1: Integrated Mode (Recommended)**

Run the MCP server automatically with the detection system:

```bash
# Activate virtual environment
source ../../venv_py311/bin/activate

# Run detection with MCP server enabled (default port 8000)
python approach_1_cnn.py --dataset all --enable-mcp

# Or specify a custom port
python approach_1_cnn.py --dataset all --enable-mcp --mcp-port 8080
```

The MCP server will:
- Start automatically in a background thread
- Use HTTP/SSE transport at `http://localhost:8000/sse` (or custom port)
- Monitor the same output directory as the detection system
- Be available for queries while detection is running
- Update metrics in real-time as data is processed

**Accessing the HTTP endpoint:**
- SSE endpoint: `http://localhost:8000/sse`
- Can be queried via HTTP clients, MCP clients, or web applications

**Option 2: Standalone Mode**

Run the MCP server separately (useful for testing or when detection is not running):

```bash
# Activate virtual environment
source ../../venv_py311/bin/activate

# Run the server
python mcp_server.py
```

**Option 3: Integration with Claude Desktop**

Add to your Claude Desktop MCP settings (`~/Library/Application Support/Claude/claude_desktop_config.json` on macOS):

```json
{
  "mcpServers": {
    "cnn-unbalance-monitor": {
      "command": "/path/to/venv_py311/bin/python",
      "args": [
        "/path/to/apps/approach_1_cnn/mcp_server.py"
      ]
    }
  }
}
```

Replace `/path/to/` with the actual absolute paths on your system.

## Data Sources

The MCP server reads from two files generated by the CNN detection system:

### 1. Performance Report
- **Location**: `../../figures/detections/performance_report_*.txt`
- **Format**: Text table with metrics
- **Updated**: Every N windows (based on `--log-interval`)
- **Purpose**: Provides current performance metrics

### 2. Detections Log
- **Location**: `../../figures/detections/detections.jsonl`
- **Format**: JSON Lines (one JSON object per line)
- **Updated**: Whenever an unbalance is detected
- **Purpose**: Tracks all detection events with details

## Example Queries

Once the MCP server is running and connected to Claude Desktop, you can ask:

- "What's the current accuracy of the unbalance detection system?"
- "Show me the latest unbalance detections"
- "Is the detection system currently running?"
- "How many false positives have occurred in dataset 0E?"
- "What was the detection ratio for the last unbalance event?"

## Workflow

### Integrated Mode (Recommended)

1. **Start detection system with MCP server**:
   ```bash
   cd approach_1_cnn
   source ../../venv_py311/bin/activate
   python approach_1_cnn.py --dataset all --enable-mcp
   ```

2. **Query from Claude Desktop or MCP client**:
   - The MCP server is automatically running in the background
   - Ask questions about the detection system
   - Get real-time metrics and detection events

### Standalone Mode

1. **Start the CNN detection system** (terminal 1):
   ```bash
   cd approach_1_cnn
   source ../../venv_py311/bin/activate
   python approach_1_cnn.py --dataset all --log-interval 10
   ```

2. **Start the MCP server** (terminal 2):
   ```bash
   cd approach_1_cnn
   source ../../venv_py311/bin/activate
   python mcp_server.py
   ```

3. **Query from Claude Desktop**:
   - The MCP server will automatically appear in Claude Desktop's available tools
   - Ask questions about the detection system
   - Claude will use the MCP tools to fetch real-time data

## Architecture

```
┌─────────────────────────────────────┐
│  CNN Detection System               │
│  (approach_1_cnn.py)                │
│                                     │
│  • Processes vibration data         │
│  • Detects unbalances               │
│  • Writes performance_report.txt    │
│  • Writes detections.jsonl          │
└──────────────┬──────────────────────┘
               │
               │ Writes files
               ▼
┌─────────────────────────────────────┐
│  File System                        │
│  figures/detections/                │
│                                     │
│  • performance_report_*.txt         │
│  • detections.jsonl                 │
│  • unbalance_detection_*.png        │
└──────────────┬──────────────────────┘
               │
               │ Reads files
               ▼
┌─────────────────────────────────────┐
│  MCP Server                         │
│  (mcp_server.py)                    │
│                                     │
│  • get_performance_metrics()        │
│  • get_recent_detections()          │
│  • get_system_status()              │
└──────────────┬──────────────────────┘
               │
               │ MCP Protocol
               ▼
┌─────────────────────────────────────┐
│  MCP Client                         │
│  (Claude Desktop, etc.)             │
│                                     │
│  • Query system status              │
│  • Analyze performance              │
│  • Monitor detections               │
└─────────────────────────────────────┘
```

## Troubleshooting

### No data available
If you get "No performance report found" errors:
- Make sure the CNN detection system is running
- Check that files are being written to `../../figures/detections/`
- Verify the MCP server has read access to the detections directory

### Stale data
If the system shows "stale" status:
- The performance report hasn't been updated in over 60 minutes
- The CNN detection system may have stopped or paused
- Check if the detection process is still running

### Import errors
If you get import errors when starting the MCP server:
- Make sure you've activated the virtual environment
- Verify fastmcp is installed: `pip list | grep fastmcp`
- Reinstall if needed: `pip install fastmcp`

## Notes

- The MCP server is read-only and does not modify any detection system files
- It automatically finds the most recent performance report file
- Detection events are appended to the JSONL file and never deleted (unless manually removed)
- The server can run independently of the detection system (it reads historical data)
