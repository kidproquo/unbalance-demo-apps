version: '3.8'

services:
  # Redis service for coordinating window processing
  redis:
    image: redis:7-alpine
    container_name: unbalance-redis
    deploy:
      resources:
        limits:
          memory: 1G  # Limit memory to prevent OOM on host
    # Port removed to prevent external access/exploitation
    networks:
      - unbalance-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Data coordinator - loads data and publishes windows with sensor data to Redis
  coordinator:
    image: ghcr.io/kidproquo/unbalanced-demo-apps:latest
    # For local development, uncomment to build from source:
    # build: .
    container_name: unbalance-coordinator
    deploy:
      resources:
        limits:
          memory: 4G  # Needs memory to load dataset
    depends_on:
      redis:
        condition: service_healthy
      approach-cnn:
        condition: service_healthy
      approach-fft:
        condition: service_healthy
      approach-rfc:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONUNBUFFERED=1
    command: >
      python -u data_coordinator.py
      --time-window 1
      --normal-weight 0.9
      --publish-rate 1.0
      --redis-host redis
      --redis-stream windows
    volumes:
      - ../data:/app/data:ro
      - ./outputs:/app/outputs
    working_dir: /app
    networks:
      - unbalance-net

  # Approach 1: CNN on Raw Sensor Data (receives data from coordinator via Redis)
  approach-cnn:
    image: ghcr.io/kidproquo/unbalanced-demo-apps:latest
    # For local development, uncomment to build from source:
    # build: .
    container_name: unbalance-cnn
    deploy:
      resources:
        limits:
          memory: 1G  # Reduced - no data loading, only model
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/ready"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 30s  # Reduced - faster startup without data loading
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONUNBUFFERED=1
    ports:
      - "12001:8000"
    command: >
      python -u approach_1_cnn/approach_1_cnn.py
      --redis-mode
      --redis-host redis
      --redis-stream windows
      --consumer-group cnn-group
      --consumer-name cnn
      --log-interval 10
      --dataset all
      --time-window 1
      --speed 1.0
      --enable-mcp
      --mcp-port 8000
      --model-path /app/models/cnn_3_layers.h5
      --output-dir /app/outputs/cnn
      --threshold 0.9
      --log-timing
    volumes:
      - ./outputs:/app/outputs
    working_dir: /app
    networks:
      - unbalance-net

  # Approach 2: FFT FCN on Frequency-transformed Data (receives data from coordinator via Redis)
  approach-fft:
    image: ghcr.io/kidproquo/unbalanced-demo-apps:latest
    # For local development, uncomment to build from source:
    # build: .
    container_name: unbalance-fft
    deploy:
      resources:
        limits:
          memory: 3G  # Needs more memory for scaler fitting
    depends_on:
      redis:
        condition: service_healthy
      approach-cnn:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/ready"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 120s  # Longer startup for data loading
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONUNBUFFERED=1
    ports:
      - "12002:8000"
    command: >
      python -u approach_2_fft/approach_2_fft.py
      --redis-mode
      --redis-host redis
      --redis-stream windows
      --consumer-group fft-group
      --consumer-name fft
      --log-interval 10
      --dataset all
      --time-window 1
      --speed 1.0
      --enable-mcp
      --mcp-port 8000
      --model-path /app/models/fft_fcn_4_layers.h5
      --output-dir /app/outputs/fft
      --data-url /app/data/fraunhofer_eas_dataset_for_unbalance_detection_v1.zip
      --threshold 0.9
      --log-timing
    volumes:
      - ./outputs:/app/outputs
      - ../data:/app/data:ro
    working_dir: /app
    networks:
      - unbalance-net

  # Approach 3: Random Forest on Minimal Features (receives data from coordinator via Redis)
  approach-rfc:
    image: ghcr.io/kidproquo/unbalanced-demo-apps:latest
    # For local development, uncomment to build from source:
    # build: .
    container_name: unbalance-rfc
    deploy:
      resources:
        limits:
          memory: 512M  # Reduced - no data loading, only small RF model
    depends_on:
      redis:
        condition: service_healthy
      approach-fft:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/ready"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 30s  # Reduced - faster startup without data loading
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PYTHONUNBUFFERED=1
    ports:
      - "12003:8000"
    command: >
      python -u approach_3_minimal_rfc/approach_3_minimal_rfc.py
      --redis-mode
      --redis-host redis
      --redis-stream windows
      --consumer-group rfc-group
      --consumer-name rfc
      --log-interval 10
      --dataset all
      --time-window 1
      --speed 1.0
      --enable-mcp
      --mcp-port 8000
      --model-path /app/models/minimal_rfc.joblib
      --output-dir /app/outputs/rfc
      --threshold 0.9
      --log-timing
    volumes:
      - ./outputs:/app/outputs
    working_dir: /app
    networks:
      - unbalance-net

networks:
  unbalance-net:
    driver: bridge

# Usage:
#   Pull images:  docker-compose pull
#   Run:          docker-compose up
#   Stop:         docker-compose down
#
# For local development with custom builds:
#   1. Uncomment "build: ." in each service
#   2. Comment out "image: ..." lines
#   3. Build:     docker-compose build
#   4. Run:       docker-compose up
#
# To use a specific version instead of :latest:
#   Replace "latest" with version tag (e.g., "v0.1.0")
#
# Configuration:
#   - Coordinator: Infinite loop, publishes 1 window/second (real-time)
#   - Time window: 1 second
#   - Processing speed: 1.0x (real-time)
#   - MCP servers enabled on ports (HTTP streamable, bound to 0.0.0.0):
#     * CNN: http://localhost:12001
#     * FFT: http://localhost:12002
#     * RFC: http://localhost:12003
#
# Startup Sequence:
#   Services start sequentially. The startup order is:
#     1. Redis (waits for health check)
#     2. CNN approach (loads model only, signals ready)
#     3. FFT approach (waits for CNN to be healthy, loads model)
#     4. RFC approach (waits for FFT to be healthy, loads model)
#     5. Coordinator (waits for all 3 approaches, loads data, starts publishing)
#
#   Data flows from Coordinator -> Redis -> Approaches (no direct data loading in approaches)
#   This significantly reduces memory usage as only the coordinator loads the dataset.
#
#   Health checks ensure each approach model is loaded before the next starts:
#   - Each approach writes /tmp/ready when model is loaded
#   - Health check verifies /tmp/ready exists (checks every 5s)
#   - start_period: 30s gives apps time to load models before health checks begin
#   - Coordinator only starts when all approaches are healthy (ready to consume)
#
# Outputs:
#   All outputs are saved to ./outputs/ directory on the host:
#     ./outputs/cnn/  - CNN detection figures and performance reports
#     ./outputs/fft/  - FFT detection figures and performance reports
#     ./outputs/rfc/  - RFC detection figures and performance reports
#
# The coordinator runs indefinitely, publishing windows at real-time speed.
# All three approaches process the same windows for direct performance comparison.
# Use Ctrl+C or 'docker-compose down' to stop.
